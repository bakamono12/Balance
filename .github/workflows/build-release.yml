name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build Android APK
        run: |
          cd android
          ./gradlew assembleRelease

      - name: Upload APK artifact
        uses: actions/upload-artifact@v3
        with:
          name: balance-android-v${{ github.ref_name }}
          path: android/app/build/outputs/apk/release/app-release.apk

  create-release:
    name: Create GitHub Release
    needs: build-android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download Android APK
        uses: actions/download-artifact@v3
        with:
          name: balance-android-v${{ github.ref_name }}
          path: ./artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Balance v${{ github.ref_name }}
          body: |
            ## Balance Expense Tracker v${{ github.ref_name }}
            
            ### What's New
            - Performance improvements for transaction list
            - Fixed safe area insets on Android
            - Added home screen widgets for quick transaction entry
            - Improved swipe-to-reveal actions
            - Bug fixes and stability improvements
            
            ### Download
            - **Android APK**: See assets below
            - **iOS IPA**: Coming soon
            
            ### Installation Instructions
            
            #### Android
            1. Download the APK file below
            2. Enable "Install from Unknown Sources" in your phone settings
            3. Open the downloaded APK file to install
            4. Launch the app and enjoy!
            
            ### System Requirements
            - Android 7.0 (API 24) or higher
            - iOS 13.0 or higher (coming soon)

          files: |
            ./artifacts/app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

